---
import { Icon } from "studiocms:ui/components/icon";
import type { TaxonomyNodeProps } from "./shared";

interface Props extends TaxonomyNodeProps {}

const {
    createCategoryLink = "/#",
    editCategoryLink = "/#",
    editTagLink = "/#",
    node,
    depth = 0,
} = Astro.props;

const nodeId = `taxonomy-${node.type}-${node.id}`;
const contentId = `content-${nodeId}`;
const href = node.type === "category" ? editCategoryLink : editTagLink;
const color = (node.meta.color as string) || "var(--primary-500)";
const hasChildren = node.children.length > 0;
---

<taxonomy-tree-node
    data-node-id={nodeId}
    data-depth={depth}
    data-href={href}
    data-taxonomy-id={node.id}
    data-taxonomy-type={node.type}
    data-create-category-link={createCategoryLink}
    data-has-children={hasChildren}
    class="tree-node"
    role="treeitem"
    aria-expanded="false"
>
    <div id={`${nodeId}-tree-node-header`} class="tree-node-header">
        {
            hasChildren && (
                <button
                    id={`${nodeId}-tree-node-toggle`}
                    class="tree-node-toggle"
                    type="button"
                    aria-controls={contentId}
                    aria-label={`Toggle ${node.name}`}
                >
                    <Icon
                        name="heroicons:chevron-right"
                        class="chevron-icon"
                        width={16}
                        height={16}
                    />
                </button>
            )
        }
        <div class="tree-node-content">
            {
                node.type === "category" ? (
                    <>
                        <Icon
                            name="heroicons:folder"
                            class="taxonomy-icon closed"
                            width={20}
                            height={20}
                            style={`color: ${color};`}
                        />
                        <Icon
                            name="heroicons:folder-open"
                            class="taxonomy-icon open"
                            width={20}
                            height={20}
                            style={`color: ${color};`}
                        />
                    </>
                ) : (
                    <Icon
                        name="heroicons:tag"
                        class="taxonomy-icon"
                        width={20}
                        height={20}
                        style={`color: ${color};`}
                    />
                )
            }
            <span class="tree-node-label">{node.name}</span>
            <span class="tree-node-count" title={node.description}>
                {node.children.length > 0 && `(${node.children.length})`}
            </span>
        </div>
    </div>
    {
        hasChildren && (
            <div class="tree-node-children" id={contentId}>
                <div class="tree-node-children-inner">
                    <slot />
                </div>
            </div>
        )
    }
    <div id={`${nodeId}-context-menu`} class="context-menu" role="menu">
        <button class="context-menu-item" role="menuitem" data-action="edit">
            <Icon name="heroicons:pencil" width={16} height={16} />
            <span>Edit {node.type === "category" ? "Category" : "Tag"}</span>
        </button>
        {
            node.type === "category" && (
                <button
                    class="context-menu-item"
                    role="menuitem"
                    data-action="create-subcategory"
                >
                    <Icon name="heroicons:folder-plus" width={16} height={16} />
                    <span>Create Subcategory</span>
                </button>
            )
        }
    </div>
</taxonomy-tree-node>

<script>
    class TaxonomyTreeNode extends HTMLElement {
        private toggleButton: HTMLButtonElement | null = null;
        private header: HTMLElement | null = null;
        private contextMenu: HTMLElement | null = null;
        private isExpanded = false;
        private href: string;
        private hasChildren: boolean;

        constructor() {
            super();
            this.href = this.getAttribute("data-href") || "#";
            this.hasChildren =
                this.getAttribute("data-has-children") === "true";
        }

        connectedCallback() {
            const nodeId = this.getAttribute("data-node-id");

            this.toggleButton = this.querySelector(
                `#${nodeId}-tree-node-toggle`,
            );
            this.header = this.querySelector(`#${nodeId}-tree-node-header`);
            this.contextMenu = this.querySelector(`#${nodeId}-context-menu`);
            this.setupEventListeners();
            if (this.hasChildren) {
                this.loadExpandedState();
            }
            this.setupContextMenu();
        }

        setupEventListeners() {
            if (!this.hasChildren) return;

            // Toggle on button click
            this.toggleButton?.addEventListener("click", (e) => {
                e.stopPropagation();
                this.toggle();
            });

            // Toggle on header click (but not the button)
            this.header?.addEventListener("click", (e) => {
                if (
                    e.target !== this.toggleButton &&
                    !this.toggleButton?.contains(e.target as Node)
                ) {
                    this.toggle();
                }
            });

            // Keyboard support
            this.addEventListener("keydown", (e) => {
                switch (e.key) {
                    case "Enter":
                    case " ":
                        e.preventDefault();
                        this.toggle();
                        break;
                    case "ArrowRight":
                        if (!this.isExpanded) {
                            e.preventDefault();
                            this.expand();
                        }
                        break;
                    case "ArrowLeft":
                        if (this.isExpanded) {
                            e.preventDefault();
                            this.collapse();
                        }
                        break;
                }
            });

            // Custom window events
            window.addEventListener("taxonomyTreeNode-collapseAll", () => {
                this.collapse();
            });

            window.addEventListener("taxonomyTreeNode-expandAll", () => {
                this.expand();
            });
        }

        setupContextMenu() {
            // Show context menu on right-click
            this.header?.addEventListener("contextmenu", (e) => {
                e.preventDefault();
                this.showContextMenu(e as MouseEvent);
            });

            // Hide context menu when clicking outside
            document.addEventListener("click", (e) => {
                if (
                    this.contextMenu &&
                    !this.contextMenu.contains(e.target as Node)
                ) {
                    this.hideContextMenu();
                }
            });

            // Handle context menu actions
            const menuItems =
                this.contextMenu?.querySelectorAll(".context-menu-item");
            menuItems?.forEach((item) => {
                item.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const action = (item as HTMLElement).getAttribute(
                        "data-action",
                    );
                    this.handleContextMenuAction(action);
                    this.hideContextMenu();
                });
            });

            // Close menu on Escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    this.hideContextMenu();
                }
            });
        }

        showContextMenu(e: MouseEvent) {
            if (!this.contextMenu) return;

            this.contextMenu.style.left = `${e.clientX}px`;
            this.contextMenu.style.top = `${e.clientY}px`;
            this.contextMenu.classList.add("active");

            requestAnimationFrame(() => {
                if (!this.contextMenu) return;
                const rect = this.contextMenu.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                if (rect.right > viewportWidth) {
                    this.contextMenu.style.left = `${e.clientX - rect.width}px`;
                }

                if (rect.bottom > viewportHeight) {
                    this.contextMenu.style.top = `${e.clientY - rect.height}px`;
                }
            });
        }

        hideContextMenu() {
            this.contextMenu?.classList.remove("active");
        }

        handleContextMenuAction(action: string | null) {
            if (!action) return;

            const taxonomyId = this.getAttribute("data-taxonomy-id");
            const taxonomyType = this.getAttribute("data-taxonomy-type");

            switch (action) {
                case "edit":
                    window.location.href = `${this.href}?edit=${taxonomyId}`;
                    break;
                case "create-subcategory":
                    const createLink = this.getAttribute(
                        "data-create-category-link",
                    );
                    window.location.href = `${createLink}?parent=${taxonomyId}`;
                    break;
            }
        }

        toggle() {
            if (this.isExpanded) {
                this.collapse();
            } else {
                this.expand();
            }
        }

        expand() {
            this.isExpanded = true;
            this.setAttribute("aria-expanded", "true");
            this.saveExpandedState();
        }

        collapse() {
            this.isExpanded = false;
            this.setAttribute("aria-expanded", "false");
            this.saveExpandedState();
        }

        saveExpandedState() {
            const taxonomyId = this.getAttribute("data-taxonomy-id");
            const taxonomyType = this.getAttribute("data-taxonomy-type");
            const key = `taxonomy-${taxonomyType}-${taxonomyId}-expanded`;
            localStorage.setItem(key, this.isExpanded.toString());
        }

        loadExpandedState() {
            const taxonomyId = this.getAttribute("data-taxonomy-id");
            const taxonomyType = this.getAttribute("data-taxonomy-type");
            const key = `taxonomy-${taxonomyType}-${taxonomyId}-expanded`;
            const saved = localStorage.getItem(key);

            if (saved === "true") {
                this.expand();
            }
        }
    }

    customElements.define("taxonomy-tree-node", TaxonomyTreeNode);
</script>
