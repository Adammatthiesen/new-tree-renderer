---
import type { FolderNode } from "../types";
import FolderTreeNode from "./FolderTreeNode.astro";
import FolderTreeLeaf from "./FolderTreeLeaf.astro";
import { Icon } from "studiocms:ui/components/icon";

interface Props {
    data: FolderNode[];
    depth?: number;
}

const { data, depth = 0 } = Astro.props;

/**
 * Recursively sorts a tree of pages and folders by name (A to Z).
 * @param data - The array of folders and pages to sort.
 * @returns A new array with the sorted structure.
 */
function sortTree(data: FolderNode[]): FolderNode[] {
    return data
        .map((node) => ({
            ...node,
            children: sortTree(node.children),
        }))
        .sort((a, b) => a.name.localeCompare(b.name));
}

const sortedData = sortTree(data);

const containerId = `folder-tree-${crypto.randomUUID()}`;
const menuId = `${containerId}-menu`;
---

<folder-tree-container
    data-create-folder-link="/#"
    data-container-id={containerId}
    data-menu-id={menuId}
>
    {
        sortedData.map((node) =>
            node.page ? (
                <FolderTreeLeaf node={node} depth={depth} />
            ) : (
                <FolderTreeNode node={node} depth={depth}>
                    {node.children && node.children.length > 0 && (
                        <Astro.self data={node.children} depth={depth + 1} />
                    )}
                </FolderTreeNode>
            ),
        )
    }
</folder-tree-container>

<div id={menuId} class="context-menu" role="menu">
    <button
        class="context-menu-item"
        role="menuitem"
        data-action="create-folder"
    >
        <Icon name="heroicons:folder-plus" width={16} height={16} />
        <span>Create Folder</span>
    </button>
</div>

<style>
    folder-tree-container {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
        width: 100%;
        height: 100%;
        padding: 0.5rem 0.2rem;
    }

    .context-menu {
        display: none;
        position: fixed;
        background-color: var(--background-step-1);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        box-shadow: 0 4px 12px var(--shadow);
        padding: 0.25rem;
        min-width: 180px;
        z-index: 1000;
    }

    .context-menu.active {
        display: block;
    }

    .context-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.5rem 0.75rem;
        background: none;
        border: none;
        border-radius: var(--radius-sm);
        color: var(--text-normal);
        font-size: 0.875rem;
        cursor: pointer;
        transition: background-color 0.15s ease;
        text-align: left;
    }

    .context-menu-item:hover {
        background-color: var(--background-step-2);
    }

    .context-menu-item:active {
        background-color: var(--background-step-3);
    }

    .context-menu-item svg {
        color: var(--text-muted);
        flex-shrink: 0;
    }

    .context-menu-item:hover svg {
        color: var(--primary-base);
    }
</style>

<script>
    class FolderTreeContainer extends HTMLElement {
        private contextMenu: HTMLElement | null = null;

        constructor() {
            super();
        }

        connectedCallback() {
            const menuId = this.getAttribute("data-menu-id");
            this.contextMenu = document.getElementById(menuId || "");
            this.setupContextMenu();
        }

        setupContextMenu() {
            // Show context menu on right-click
            this.addEventListener("contextmenu", (e) => {
                const target = e.target as HTMLElement;

                // Only show menu if NOT clicking on nodes or leaves
                if (
                    target.closest("folder-tree-node") ||
                    target.closest("folder-tree-leaf")
                ) {
                    return;
                }

                e.preventDefault();
                this.showContextMenu(e as MouseEvent);
            });

            // Hide context menu when clicking outside
            document.addEventListener("click", (e) => {
                if (
                    this.contextMenu &&
                    !this.contextMenu.contains(e.target as Node)
                ) {
                    this.hideContextMenu();
                }
            });

            // Handle context menu actions
            const menuItems =
                this.contextMenu?.querySelectorAll(".context-menu-item");
            menuItems?.forEach((item) => {
                item.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const action = (item as HTMLElement).getAttribute(
                        "data-action",
                    );
                    this.handleContextMenuAction(action);
                    this.hideContextMenu();
                });
            });

            // Close menu on Escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    this.hideContextMenu();
                }
            });
        }

        showContextMenu(e: MouseEvent) {
            if (!this.contextMenu) {
                console.error("Context menu not found");
                return;
            }

            // Position the menu at cursor
            this.contextMenu.style.left = `${e.pageX}px`;
            this.contextMenu.style.top = `${e.pageY}px`;
            this.contextMenu.classList.add("active");

            // Adjust if menu goes off-screen
            requestAnimationFrame(() => {
                if (!this.contextMenu) return;
                const rect = this.contextMenu.getBoundingClientRect();
                console.log("Menu rect:", rect);
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                if (rect.right > viewportWidth) {
                    this.contextMenu.style.left = `${e.pageX - rect.width}px`;
                }

                if (rect.bottom > viewportHeight) {
                    this.contextMenu.style.top = `${e.pageY - rect.height}px`;
                }
            });
        }

        hideContextMenu() {
            this.contextMenu?.classList.remove("active");
        }

        handleContextMenuAction(action: string | null) {
            const createFolderLink = this.getAttribute(
                "data-create-folder-link",
            );

            switch (action) {
                case "create-folder":
                    if (createFolderLink && createFolderLink !== "#") {
                        window.location.href = createFolderLink;
                    } else {
                        console.log("Create folder action triggered");
                        // You can dispatch a custom event here for parent components to handle
                        this.dispatchEvent(
                            new CustomEvent("create-folder", {
                                bubbles: true,
                                composed: true,
                            }),
                        );
                    }
                    break;
            }
        }
    }

    if (!customElements.get("folder-tree-container")) {
        customElements.define("folder-tree-container", FolderTreeContainer);
    }
</script>
